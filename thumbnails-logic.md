# Story Thumbnails Logic - WP Story Premium

This document explains how the WP Story Premium plugin creates and stores story thumbnails.

## General Overview

Story thumbnails are primarily managed through WordPress's **Featured Images** system and custom metadata. The system implements multiple fallback strategies to ensure there is always an image available to display in the story circles.

## Thumbnail Creation Flow

### 1. When Creating a New Story (Public Stories)

**Location:** `includes/class-wpstory-premium-submit.php`

#### Process in `submit_handler_user_public()`:

1. **Getting the parent thumbnail:**
   - If an existing category is selected (`wpstory-story-parent`), the existing thumbnail is obtained:
   ```php
   $parent_thumb = get_post_thumbnail_id( $parent_id );
   ```

2. **If a new category is created:**
   - The attachment ID is received from the form: `wpstory-story-media-id`
   - It is validated as a valid attachment
   - It is assigned as the featured image of the new parent post:
   ```php
   if ( ! empty( $parent_thumb ) ) {
       set_post_thumbnail( $parent_id, $parent_thumb );
   }
   ```

3. **Storing thumbnail information:**
   - Complete image information is saved in the child post meta:
   ```php
   'image' => array(
       'url'       => wp_get_attachment_url( $attachment_id ),
       'id'        => $attachment_id,
       'thumbnail' => wp_get_attachment_image_url( $attachment_id, 'thumbnail', true ),
   )
   ```

### 2. When Creating an Individual Story (Single Stories)

**Location:** `includes/class-wpstory-premium-submit.php`

#### Process in `submit_handler_user_single()`:

Similar to the previous process, but without the parent logic. It is stored directly:
- The full image URL
- The attachment ID
- The thumbnail URL automatically generated by WordPress ('thumbnail' size)

## Thumbnail Retrieval Flow for Display

### 1. For "Box" Type Stories (Normal Stories)

**Location:** `includes/class-wpstory-premium-creator.php`

#### Method `get_stories()` (lines 230-236):

```php
if ( has_post_thumbnail() ) {
    $circle_image    = get_the_post_thumbnail_url( get_the_ID(), WPSTORY()->story_thumbnail_size( $box_id ) );
    $circle_image_ID = get_the_ID();
} else {
    // Fallback: use the first story item
    $circle_image    = $story_items_arr[0]['src'];
    $circle_image_ID = $story_items_arr[0]['srcID'];
}
```

**Strategy:**
1. **First option:** Use the post's featured image if it exists
2. **Fallback:** Use the first image from the story items
3. **Dynamic size:** The size is determined according to the style (`story_thumbnail_size()`)

### 2. For Normal Post Stories

**Location:** `includes/class-wpstory-premium-creator.php`

#### Method `get_post_stories()` (lines 370-383):

This method implements more complex logic with multiple sources:

1. **Attempts to get thumbnail from custom meta:**
   ```php
   $meta_thumbnail = get_post_meta( get_the_ID(), 'wp-story-cycle-image', true );
   $meta_thumbnail = isset( $meta_thumbnail['id'] ) ? $meta_thumbnail['id'] : null;
   ```

2. **If it doesn't exist, uses the featured image:**
   ```php
   if ( ! empty( $meta_thumbnail ) ) {
       $thumbnail_id = $meta_thumbnail;
   } else {
       $thumbnail_id = get_post_thumbnail_id( $story_id );
   }
   ```

3. **Validation:** If there is no thumbnail or custom meta, the story is skipped:
   ```php
   if ( ! has_post_thumbnail( $story_id ) && empty( $meta_thumbnail ) ) {
       continue;
   }
   ```

4. **Getting image metadata:**
   - Attachment metadata is obtained to determine orientation (vertical/horizontal)
   ```php
   $thumbnail_meta = wp_get_attachment_metadata( $thumbnail_id );
   ```

### 3. For Category Stories

**Location:** `includes/class-wpstory-premium-creator.php`

#### Method `get_category_stories()` (lines 574-622):

1. **Category thumbnail:**
   ```php
   $meta_thumbnail = get_term_meta( $cat_term->term_id, 'wpstory-image', true );
   $story_image_id = $meta_thumbnail['id'] ?? null;
   ```

2. **Individual post thumbnails:**
   - For each post in the category:
   ```php
   $meta_thumbnail = get_post_meta( $cur_post_id, 'wp-story-cycle-image', true );
   ```
   - If the first post doesn't have a category image, it uses the first post's thumbnail:
   ```php
   if ( $i === 0 ) {
       if ( empty( $story_image_id ) ) {
           $story_image_id = $thumbnail_id;
       }
   }
   ```

### 4. For Public User Stories

**Location:** `includes/class-wpstory-premium-creator.php`

#### Method `get_user_public_stories()` (lines 903-910):

1. **Priority to featured image:**
   ```php
   if ( has_post_thumbnail( $story_parent_id ) ) {
       $circle_image_id   = get_post_thumbnail_id( $story_parent_id );
       $circle_image      = wp_get_attachment_image_url( $circle_image_id, 'medium' );
       $circle_image_type = wp_attachment_is( 'image', $circle_image_id ) ? 'image' : 'video';
   } else {
       // Fallback to first item preview
       $circle_image      = $story_items_arr[0]['preview'];
       $circle_image_type = $story_items_arr[0]['type'];
   }
   ```

### 5. For Web Stories (Google Web Stories Integration)

**Location:** `integrations/web-stories/Model/Story.php`

#### Method `load_from_post()` (lines 34-51):

1. **Gets the post thumbnail:**
   ```php
   $thumbnail_id = (int) get_post_thumbnail_id( $post );
   ```

2. **Generates multiple sizes and srcset:**
   - Gets the image in 'medium' size
   - Calculates sizes and srcset for responsive
   - Stores complete information including dimensions

## Thumbnail Sizes

**Location:** `includes/class-wpstory-premium-helpers.php`

#### Method `story_thumbnail_size()` (lines 418-439):

The thumbnail size depends on the selected style:

- **snapgram:** `wpstory-circle` (if enabled)
- **snapssenger:** `wpstory-square` (if enabled)
- **vemdezap:** `wpstory-list` (if enabled)
- **Default:** `full` (full size)

## Storage Methods

### 1. WordPress Featured Image

- **Function:** `set_post_thumbnail( $post_id, $thumbnail_id )`
- **Retrieval:** `get_post_thumbnail_id( $post_id )`
- **URL:** `get_the_post_thumbnail_url( $post_id, $size )`

### 2. Custom Post Metadata

- **`wp-story-cycle-image`:** Specific thumbnail to display in the circle
- **`wp-story-image`:** Main story image
- **`wp-story-metabox`:** Container with all story items

### 3. Attachment Metadata

- **`_wp_attachment_metadata`:** Stores dimensions, generated sizes, etc.
- **Function:** `wp_get_attachment_metadata( $attachment_id )`

### 4. Term Metadata (Categories)

- **`wpstory-image`:** Custom image for categories
- **Function:** `get_term_meta( $term_id, 'wpstory-image', true )`

## Image Upload Process

**Location:** `includes/class-wpstory-premium-submit.php`

#### Method `ajax_upload()` (lines 552-618):

1. **File type validation:**
   - Verifies that the MIME type is allowed
   - For videos, uses `media_handle_upload()`
   - For images, processes manually

2. **File creation:**
   - Generates unique name with hash: `md5( $blob_name . microtime() )`
   - Moves the file to the uploads directory

3. **WordPress registration:**
   ```php
   $attachment_id = wp_insert_attachment( $attachment, $filename );
   $attachment_meta = wp_generate_attachment_metadata( $attachment_id, $filename );
   wp_update_attachment_metadata( $attachment_id, $attachment_meta );
   ```
   - WordPress automatically generates all sizes (thumbnail, medium, large, etc.)

4. **Post relationship:**
   ```php
   wp_update_post( array(
       'ID' => $attachment_id,
       'post_parent' => $story_id,
   ) );
   ```

## Fallback Strategy (Priority Order)

When displaying a thumbnail, the system tries in this order:

1. **Post's Featured Image** (`has_post_thumbnail()`)
2. **Custom meta `wp-story-cycle-image`**
3. **First story item** (`$story_items_arr[0]['src']`)
4. **Category thumbnail** (only for category stories)
5. **First item preview** (for user stories)

## Important Considerations

1. **Security Validation:**
   - It is always validated that the attachment ID is actually an attachment: `get_post_type( $attachment_id ) === 'attachment'`

2. **Backward Compatibility:**
   - The system maintains compatibility with the old metadata structure (`wp_story_items`)

3. **Image Orientation:**
   - It is determined whether an image is horizontal or vertical by comparing width and height in the metadata

4. **Responsive Sizes:**
   - For Web Stories, srcset and sizes are generated for responsive images

## Key Files

- `includes/class-wpstory-premium-submit.php` - Creation and storage
- `includes/class-wpstory-premium-creator.php` - Retrieval and rendering
- `includes/class-wpstory-premium-helpers.php` - Helper functions (sizes)
- `integrations/web-stories/Model/Story.php` - Web Stories integration
- `admin/metabox.php` - Admin interface
